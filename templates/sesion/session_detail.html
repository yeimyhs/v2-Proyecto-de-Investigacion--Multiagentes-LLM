<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Chat con Gemini{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/sesionconfbase.css' %}">
    {% block extra_styles %}{% endblock %}
</head>
<body>
<div class="session-container">
    <h2>Detalles de la Sesión: {{ session.nombre }}</h2>
    <p><strong>Duración de la Sesion:</strong> {{ session.duration }}</p>

    <h3>Temas Requerimiento de la Sesion:</h3>
    <p>Es importante indicar los temas que quiere que se tengan en cuenta durante la sesion.</p>
    <ul id="topics-list">
        {% for requerimiento in session.lista_requerimientos %}
            <li>
                <span>{{ requerimiento.topic_d.name }}</span>
                <span class="hidden-state"> - {{ requerimiento.state }}</span>
                <button class="delete-btn" data-id="{{ requerimiento.id }}">-</button>
            </li>
        {% empty %}
            <p class="no-items">No hay requerimientos para esta sesión.</p>
        {% endfor %}
    </ul>
    <button class="circle-btn" id="add-topic-btn">+ Tema</button>

    <h3>Técnicas de aprendizaje: </h3>
    <p>Técnicas de aprendizaje a desarrollar durante la sesion.</p>
    <ul id="techniques-list">
        {% for tecnica in session.tecnicas_recomendadas_a_usar_sesion %}
            <li>{{ tecnica.technique_d.name }}
                <button class="delete-btn" data-id="{{ tecnica.id }}">-</button>
            </li>
        {% empty %}
            <p class="no-items">No hay técnicas recomendadas para esta sesión.</p>
        {% endfor %}
    </ul>
    <button class="circle-btn" id="add-technique-btn">+ Técnica</button>

    <!-- Overlay para los formularios -->
    <div id="overlay" class="overlay">
        <!-- Formulario para temas -->
        <div class="card hidden" id="topic-card">
            <h4>Agregar Tema</h4>
            <form id="topic-form">
                <label for="topic-select">Selecciona un Tema:</label>
                <select id="topic-select" name="topic" required>
                    <!-- Los temas se cargarán aquí -->
                </select>
                <button type="submit">Guardar</button>
                <button type="button" id="close-topic-modal">Cancelar</button>
            </form>
        </div>

        <!-- Formulario para técnicas -->
        <div class="card hidden" id="technique-card">
            <h4>Agregar Técnica</h4>
            <form id="technique-form">
                <label for="technique-select">Selecciona una Técnica:</label>
                <select id="technique-select" name="technique" required>
                    <!-- Las técnicas se cargarán aquí -->
                </select>
                <button type="submit">Guardar</button>
                <button type="button" id="close-technique-modal">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Contenedor de mensajes -->
    <div id="message-container" class="hidden"></div>
</div>

<!-- Scripts -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const sessionId = "{{ session.idsession }}";

        // Elementos del DOM
        const overlay = document.getElementById("overlay");
        const messageContainer = document.getElementById("message-container");

        const topicCard = document.getElementById("topic-card");
        const techniqueCard = document.getElementById("technique-card");

        const addTopicBtn = document.getElementById("add-topic-btn");
        const addTechniqueBtn = document.getElementById("add-technique-btn");

        const closeTopicModal = document.getElementById("close-topic-modal");
        const closeTechniqueModal = document.getElementById("close-technique-modal");

        const topicForm = document.getElementById("topic-form");
        const techniqueForm = document.getElementById("technique-form");

        const topicSelect = document.getElementById("topic-select");
        const techniqueSelect = document.getElementById("technique-select");

        // Función para mostrar mensajes
        const showMessage = (message, success = true) => {
            messageContainer.textContent = message;
            messageContainer.className = success ? "message success" : "message error";
            messageContainer.classList.remove("hidden");

            setTimeout(() => {
                messageContainer.classList.add("hidden");
            }, 3000);
        };

        // Función para cerrar el modal y recargar la página
        const closeModalAndReload = () => {
            overlay.style.display = "none";
            topicCard.classList.add("hidden");
            techniqueCard.classList.add("hidden");
            location.reload();
        };

        // Obtener temas y llenar el desplegable
        fetch('/sesion/topics/')
            .then(response => response.json())
            .then(data => {
                data.forEach(topic => {
                    const option = document.createElement("option");
                    option.value = topic.idTopic;
                    option.textContent = topic.name;
                    topicSelect.appendChild(option);
                });
            });

        // Obtener técnicas y llenar el desplegable
        fetch('/sesion/learning-technique/')
            .then(response => response.json())
            .then(data => {
                data.forEach(technique => {
                    const option = document.createElement("option");
                    option.value = technique.idtechnique;
                    option.textContent = technique.name;
                    techniqueSelect.appendChild(option);
                });
            });

        // Mostrar formularios
        addTopicBtn.addEventListener("click", () => {
            overlay.style.display = "flex";
            topicCard.classList.remove("hidden");
        });

        addTechniqueBtn.addEventListener("click", () => {
            overlay.style.display = "flex";
            techniqueCard.classList.remove("hidden");
        });

        // Cerrar formularios
        closeTopicModal.addEventListener("click", closeModalAndReload);
        closeTechniqueModal.addEventListener("click", closeModalAndReload);

        // Enviar nuevo tema
        topicForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const topicId = document.getElementById("topic-select").value;

            fetch('/sesion/topics-requirement/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session: sessionId, topic: topicId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al agregar tema.");
                }
                return response.json();
            })
            .then(() => {
                showMessage("¡Tema agregado exitosamente!");
                closeModalAndReload();
            })
            .catch(() => showMessage("Error al agregar tema.", false));
        });

        // Enviar nueva técnica
        techniqueForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const techniqueId = document.getElementById("technique-select").value;

            fetch('/sesion/recommended-techniques/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session: sessionId, technique: techniqueId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al agregar técnica.");
                }
                return response.json();
            })
            .then(() => {
                showMessage("¡Técnica agregada exitosamente!");
                closeModalAndReload();
            })
            .catch(() => showMessage("Error al agregar técnica.", false));
        });

        // Función para eliminar un tema
        const deleteTopic = (id) => {
            fetch(`/sesion/topics-requirement/${id}/`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al eliminar el tema.");
                }
                showMessage("¡Tema eliminado exitosamente!");
                location.reload();  // Recargar la página para reflejar los cambios
            })
            .catch(() => showMessage("Error al eliminar el tema.", false));
        };

        // Función para eliminar una técnica
        const deleteTechnique = (id) => {
            fetch(`/sesion/recommended-techniques/${id}/`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al eliminar la técnica.");
                }
                showMessage("¡Técnica eliminada exitosamente!");
                location.reload();  // Recargar la página para reflejar los cambios
            })
            .catch(() => showMessage("Error al eliminar la técnica.", false));
        };

        // Asociar eventos de clic a los botones de eliminación
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const id = event.target.getAttribute('data-id');
                if (event.target.closest('li').parentNode.id === "topics-list") {
                    deleteTopic(id);
                } else if (event.target.closest('li').parentNode.id === "techniques-list") {
                    deleteTechnique(id);
                }
            });
        });
    });
</script>
</body>
</html>
